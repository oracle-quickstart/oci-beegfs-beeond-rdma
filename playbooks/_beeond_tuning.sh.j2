#!/bin/bash

set -x

# all
echo '
net.ipv4.neigh.default.gc_thresh1=1100
net.ipv4.neigh.default.gc_thresh2=2200
net.ipv4.neigh.default.gc_thresh4=4400
' >> /etc/sysctl.conf
sysctl -p /etc/sysctl.conf


mkdir -p /etc/beegfs/tuning

echo '
connMaxInternodeNum          = 800
tuneNumWorkers               = 128
' > /etc/beegfs/tuning/beegfs-meta.conf


echo '
connMaxInternodeNum          = 800
tuneNumWorkers               = 128
tuneFileReadAheadSize        = 32m
tuneFileReadAheadTriggerSize = 2m
tuneFileReadSize             = 256k
tuneFileWriteSize            = 256k
tuneWorkerBufSize            = 16m
tuneBindToNumaZone           = 0
' > /etc/beegfs/tuning/beegfs-storage.conf

# Set preferred storage target to be local to the node.  This makes sense if we plan to use numtargets=1 for IO
targetNumID=`ip addr | grep "192.168" | gawk -F" " '{ print $2 }' | gawk -F"/" '{ print $1 }' | gawk -F"." '{ print $4 }'`
type="client"
echo "$targetNumID" > /etc/beegfs/tuning/${type}-tunePreferredStorageFile.conf
##sed -i "s|tunePreferredStorageFile.*=.*|tunePreferredStorageFile          = /etc/beegfs/${type}-tunePreferredStorageFile.conf|g"  /etc/beegfs/beegfs-${type}.conf


echo '
connRDMABufSize              = 32768
connMaxInternodeNum          = 800
tuneNumWorkers               = 128
#tunePreferredStorageFile     = /etc/beegfs/tuning/client-tunePreferredStorageFile.conf
' > /etc/beegfs/tuning/beegfs-client.conf




# mds
##sed -i 's/^connMaxInternodeNum/connMaxInternodeNum          = 800/g'  /etc/beegfs/beegfs-meta.conf
##sed -i 's/^tuneNumWorkers/tuneNumWorkers               = 128/g'  /etc/beegfs/beegfs-meta.conf

# mds - 90-beegfs-mds-sysctl.conf
# Assume this applies to TCP version only for now.  Test without it and then run another test with it
# echo '
# proc.sys.vm.dirty_background_ratio=5
# proc.sys.vm.dirty_ratio=20
# proc.sys.vm.vfs_cache_pressure=50
# proc.sys.vm.min_free_kbytes=262144
# proc.sys.vm.zone_reclaim_mode=1
# sys.kernel.mm.transparent_hugepage.enabled=always
# sys.kernel.mm.transparent_hugepage.defrag=always
# ' >> /etc/sysctl.conf



# oss
##sed -i 's/^connMaxInternodeNum/connMaxInternodeNum               = 800/g'  /etc/beegfs/beegfs-storage.conf
##sed -i 's/^tuneNumWorkers/tuneNumWorkers               = 128/g'  /etc/beegfs/beegfs-storage.conf
##sed -i 's/^tuneFileReadAheadSize/tuneFileReadAheadSize               = 32m/g'  /etc/beegfs/beegfs-storage.conf
##sed -i 's/^tuneFileReadAheadTriggerSize/tuneFileReadAheadTriggerSize               = 2m/g'  /etc/beegfs/beegfs-storage.conf
##sed -i 's/^tuneFileReadSize/tuneFileReadSize               = 256k/g'  /etc/beegfs/beegfs-storage.conf
##sed -i 's/^tuneFileWriteSize/tuneFileWriteSize               = 256k/g'  /etc/beegfs/beegfs-storage.conf
##sed -i 's/^tuneWorkerBufSize/tuneWorkerBufSize               = 16m/g'  /etc/beegfs/beegfs-storage.conf





##if [ "{{ use_beegfs_over_rdma }}" = "true" ]; then
  ##sed -i 's/tuneBindToNumaZone.*=/tuneBindToNumaZone           = 0/g'  /etc/beegfs/beegfs-storage.conf
  ##sed -i 's/connRDMABufSize.*= 8192/connRDMABufSize               = 32768/g'  /etc/beegfs/beegfs-client.conf
##fi

# common tuning - irrespective of RDMA or TCP
##sed -i 's/connMaxInternodeNum.*= 12/connMaxInternodeNum          = 64/g'  /etc/beegfs/beegfs-client.conf
##sed -i 's/tuneNumWorkers.*= 12/tuneNumWorkers               = 128/g'  /etc/beegfs/beegfs-storage.conf


# Set preferred storage target to be local to the node.  This makes sense if we plan to use numtargets=1 for IO
##targetNumID=`ip addr | grep "192.168" | gawk -F" " '{ print $2 }' | gawk -F"/" '{ print $1 }' | gawk -F"." '{ print $4 }'`
##type="client"
##echo "$targetNumID" > /etc/beegfs/tuning/${type}-tunePreferredStorageFile.conf
##sed -i "s|tunePreferredStorageFile.*=.*|tunePreferredStorageFile          = /etc/beegfs/${type}-tunePreferredStorageFile.conf|g"  /etc/beegfs/beegfs-${type}.conf
